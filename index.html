<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sneaky Scholar - The Ultimate Nose-Picking Adventure</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>

  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Fredoka', sans-serif; overflow: hidden; touch-action: none; background: #1a1a2e; }
    #root { width: 100vw; height: 100vh; }

    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes shake { 
      0%, 100% { transform: translateX(0) rotate(0deg); } 
      25% { transform: translateX(-10px) rotate(-5deg); } 
      75% { transform: translateX(10px) rotate(5deg); } 
    }
    @keyframes slideIn { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); } 50% { opacity: 1; transform: scale(1) rotate(180deg); } }
    @keyframes coinCollect { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(0.5); opacity: 0; } }
    
    @keyframes teacherTurn {
      0% { transform: translateY(-50%) rotateY(180deg); }
      100% { transform: translateY(-50%) rotateY(0deg); }
    }
    
    @keyframes teacherTurnAway {
      0% { transform: translateY(-50%) rotateY(0deg); }
      100% { transform: translateY(-50%) rotateY(180deg); }
    }

    @keyframes caughtShake {
      0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
      10%, 30%, 50%, 70%, 90% { transform: translate(-50%, -50%) rotate(-10deg); }
      20%, 40%, 60%, 80% { transform: translate(-50%, -50%) rotate(10deg); }
    }
  </style>

</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // Audio context for sound effects
    const AudioManager = {
      context: null,
      init() {
        this.context = new (window.AudioContext || window.webkitAudioContext)();
      },
      playBeep(frequency, duration, type = 'sine') {
        try {
          if (!this.context) this.init();
          if (this.context.state === 'suspended') this.context.resume();

          const oscillator = this.context.createOscillator();
          const gainNode = this.context.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(this.context.destination);

          oscillator.frequency.value = frequency;
          oscillator.type = type;

          gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);

          oscillator.start(this.context.currentTime);
          oscillator.stop(this.context.currentTime + duration);
        } catch (e) {
          console.log('Audio error:', e);
        }
      },
      playSuccess() {
        this.playBeep(523.25, 0.1);
        setTimeout(() => this.playBeep(659.25, 0.1), 100);
        setTimeout(() => this.playBeep(783.99, 0.2), 200);
      },
      playFail() {
        this.playBeep(200, 0.1, 'square');
        setTimeout(() => this.playBeep(150, 0.2, 'square'), 100);
      },
      playClick() {
        this.playBeep(800, 0.05);
      },
      playCoin() {
        this.playBeep(1000, 0.05);
        setTimeout(() => this.playBeep(1200, 0.05), 50);
      },
      playLevelUp() {
        [523.25, 587.33, 659.25, 783.99, 880, 1046.5].forEach((freq, i) => {
          setTimeout(() => this.playBeep(freq, 0.1), i * 80);
        });
      }
    };

    // Game data
    const LEVELS = [
      { id: 1, name: "Classroom Rookie", time: 10, catches: 3, reward: 50, difficulty: 1 },
      { id: 2, name: "Stealth Student", time: 12, catches: 3, reward: 75, difficulty: 1.2 },
      { id: 3, name: "Ninja Scholar", time: 15, catches: 3, reward: 100, difficulty: 1.4 },
      { id: 4, name: "Quick Fingers", time: 10, catches: 2, reward: 150, difficulty: 1.5 },
      { id: 5, name: "Speed Demon", time: 8, catches: 2, reward: 200, difficulty: 1.7 },
      { id: 6, name: "Master Picker", time: 12, catches: 2, reward: 250, difficulty: 1.8 },
      { id: 7, name: "Eagle Eye Test", time: 10, catches: 1, reward: 300, difficulty: 2 },
      { id: 8, name: "Lightning Round", time: 6, catches: 1, reward: 400, difficulty: 2.2 },
      { id: 9, name: "Legendary Status", time: 8, catches: 1, reward: 500, difficulty: 2.5 },
      { id: 10, name: "Ultimate Challenge", time: 5, catches: 1, reward: 1000, difficulty: 3 }
    ];

    const ACHIEVEMENTS = [
      { id: 'first_win', name: 'First Success', desc: 'Complete your first level', reward: 50 },
      { id: 'quick_draw', name: 'Quick Draw', desc: 'Complete a level in under 5 seconds', reward: 100 },
      { id: 'perfect', name: 'Perfect Run', desc: 'Complete a level without being caught', reward: 150 },
      { id: 'coin_collector', name: 'Coin Collector', desc: 'Earn 500 total coins', reward: 100 },
      { id: 'level_5', name: 'Halfway There', desc: 'Reach level 5', reward: 200 },
      { id: 'level_10', name: 'The Ultimate', desc: 'Complete all 10 levels', reward: 500 },
      { id: 'speed_demon', name: 'Speed Demon', desc: 'Complete 5 levels in a row', reward: 250 }
    ];

    const SHOP_ITEMS = [
      { id: 'rainbow_finger', name: 'Rainbow Finger', cost: 200, type: 'skin' },
      { id: 'golden_finger', name: 'Golden Finger', cost: 500, type: 'skin' },
      { id: 'ninja_finger', name: 'Ninja Finger', cost: 300, type: 'skin' },
      { id: 'extra_life', name: 'Extra Life', cost: 100, type: 'powerup' },
      { id: 'slow_time', name: 'Slow Motion', cost: 150, type: 'powerup' },
      { id: 'invisible', name: 'Invisibility', cost: 250, type: 'powerup' }
    ];

    // Main Game Component
    function Game() {
      const [screen, setScreen] = useState('menu');
      const [level, setLevel] = useState(1);
      const [coins, setCoins] = useState(0);
      const [unlockedLevels, setUnlockedLevels] = useState([1]);
      const [achievements, setAchievements] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [selectedSkin, setSelectedSkin] = useState('default');
      const [consecutiveWins, setConsecutiveWins] = useState(0);

      useEffect(() => {
        const saved = localStorage.getItem('sneakyScholarSave');
        if (saved) {
          const data = JSON.parse(saved);
          setCoins(data.coins || 0);
          setUnlockedLevels(data.unlockedLevels || [1]);
          setAchievements(data.achievements || []);
          setInventory(data.inventory || []);
          setSelectedSkin(data.selectedSkin || 'default');
        }
      }, []);

      const saveGame = useCallback(() => {
        const data = { coins, unlockedLevels, achievements, inventory, selectedSkin };
        localStorage.setItem('sneakyScholarSave', JSON.stringify(data));
      }, [coins, unlockedLevels, achievements, inventory, selectedSkin]);

      useEffect(() => { saveGame(); }, [saveGame]);

      const unlockAchievement = (achievementId) => {
        if (!achievements.includes(achievementId)) {
          const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
          setAchievements(prev => [...prev, achievementId]);
          setCoins(c => c + (achievement?.reward || 0));
          AudioManager.playLevelUp();
          return achievement;
        }
        return null;
      };

      const handleLevelComplete = (time, caughtCount) => {
        const currentLevel = LEVELS.find(l => l.id === level);
        const reward = currentLevel.reward;
        const bonusCoins = caughtCount === 0 ? 50 : 0;

        setCoins(c => c + reward + bonusCoins);
        AudioManager.playSuccess();

        if (level < LEVELS.length && !unlockedLevels.includes(level + 1)) {
          setUnlockedLevels(prev => [...prev, level + 1]);
        }

        if (achievements.length === 0) unlockAchievement('first_win');
        if (time < 5) unlockAchievement('quick_draw');
        if (caughtCount === 0) unlockAchievement('perfect');
        if (level === 5) unlockAchievement('level_5');
        if (level === 10) unlockAchievement('level_10');

        const newConsecutive = consecutiveWins + 1;
        setConsecutiveWins(newConsecutive);
        if (newConsecutive >= 5) unlockAchievement('speed_demon');

        if (coins + reward + bonusCoins >= 500) unlockAchievement('coin_collector');
      };

      const handleLevelFail = () => {
        AudioManager.playFail();
        setConsecutiveWins(0);
      };

      if (screen === 'menu') {
        return (
          <MenuScreen
            onStart={() => setScreen('game')}
            onLevelSelect={() => setScreen('levelSelect')}
            onShop={() => setScreen('shop')}
            onAchievements={() => setScreen('achievements')}
            coins={coins}
          />
        );
      }

      if (screen === 'levelSelect') {
        return (
          <LevelSelectScreen
            levels={LEVELS}
            unlockedLevels={unlockedLevels}
            onSelectLevel={(lvl) => { setLevel(lvl); setScreen('game'); }}
            onBack={() => setScreen('menu')}
          />
        );
      }

      if (screen === 'shop') {
        return (
          <ShopScreen
            coins={coins}
            inventory={inventory}
            selectedSkin={selectedSkin}
            onPurchase={(item) => { setCoins(c => c - item.cost); setInventory(prev => [...prev, item.id]); AudioManager.playCoin(); }}
            onSelectSkin={(skin) => setSelectedSkin(skin)}
            onBack={() => setScreen('menu')}
          />
        );
      }

      if (screen === 'achievements') {
        return (
          <AchievementsScreen
            achievements={achievements}
            allAchievements={ACHIEVEMENTS}
            onBack={() => setScreen('menu')}
          />
        );
      }

      if (screen === 'game') {
        return (
          <GameScreen
            level={LEVELS.find(l => l.id === level)}
            skin={selectedSkin}
            onWin={(time, caughtCount) => { handleLevelComplete(time, caughtCount); setScreen('levelSelect'); }}
            onLose={() => { handleLevelFail(); setScreen('levelSelect'); }}
            onQuit={() => setScreen('menu')}
          />
        );
      }

      return null;
    }

    // Menu Screen Component
    function MenuScreen({ onStart, onLevelSelect, onShop, onAchievements, coins }) {
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          position: 'relative',
          overflow: 'hidden'
        }}>
          <div style={{ position: 'absolute', top: '10%', left: '10%', fontSize: '60px', opacity: 0.2, animation: 'float 3s ease-in-out infinite' }}>ğŸ“š</div>
          <div style={{ position: 'absolute', top: '60%', right: '15%', fontSize: '50px', opacity: 0.2, animation: 'float 4s ease-in-out infinite' }}>âœï¸</div>

          <div style={{ textAlign: 'center', animation: 'slideIn 0.5s ease-out' }}>
            <h1 style={{
              fontFamily: "'Press Start 2P', cursive",
              fontSize: 'clamp(24px, 6vw, 48px)',
              color: '#fff',
              textShadow: '4px 4px 0 rgba(0,0,0,0.3)',
              marginBottom: '10px',
              lineHeight: 1.4
            }}>SNEAKY<br/>SCHOLAR</h1>

            <div style={{ fontSize: '60px', marginBottom: '20px', animation: 'pulse 2s ease-in-out infinite' }}>ğŸ‘ƒâœ‹</div>

            <p style={{ color: 'white', fontSize: '18px', marginBottom: '30px', opacity: 0.9 }}>
              The Ultimate Nose-Picking Adventure
            </p>

            <div style={{
              background: 'rgba(255,255,255,0.2)',
              borderRadius: '20px',
              padding: '15px 30px',
              marginBottom: '30px',
              backdropFilter: 'blur(10px)'
            }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FFD700' }}>ğŸ’° {coins} Coins</div>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '15px', alignItems: 'center' }}>
              <MenuButton onClick={onStart} primary>ğŸ® QUICK PLAY</MenuButton>
              <MenuButton onClick={onLevelSelect}>ğŸ“Š LEVEL SELECT</MenuButton>
              <MenuButton onClick={onShop}>ğŸ›’ SHOP</MenuButton>
              <MenuButton onClick={onAchievements}>ğŸ† ACHIEVEMENTS</MenuButton>
            </div>
          </div>
        </div>
      );
    }

    function MenuButton({ children, onClick, primary }) {
      return (
        <button
          onClick={() => { AudioManager.playClick(); onClick(); }}
          style={{
            background: primary ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'rgba(255,255,255,0.9)',
            color: primary ? 'white' : '#764ba2',
            border: 'none',
            borderRadius: '15px',
            padding: '18px 40px',
            fontSize: '18px',
            fontWeight: 'bold',
            fontFamily: 'Fredoka',
            cursor: 'pointer',
            boxShadow: '0 6px 20px rgba(0,0,0,0.2)',
            transition: 'all 0.3s',
            minWidth: '250px',
            textAlign: 'center'
          }}
          onMouseDown={(e) => (e.currentTarget.style.transform = 'scale(0.95)')}
          onMouseUp={(e) => (e.currentTarget.style.transform = 'scale(1)')}
          onTouchStart={(e) => (e.currentTarget.style.transform = 'scale(0.95)')}
          onTouchEnd={(e) => (e.currentTarget.style.transform = 'scale(1)')}
        >
          {children}
        </button>
      );
    }

    // Level Select Screen
    function LevelSelectScreen({ levels, unlockedLevels, onSelectLevel, onBack }) {
      return (
        <div style={{ width: '100%', height: '100%', background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', overflowY: 'auto', padding: '20px' }}>
          <button
            onClick={() => { AudioManager.playClick(); onBack(); }}
            style={{ background: 'rgba(255,255,255,0.9)', border: 'none', borderRadius: '10px', padding: '10px 20px', fontSize: '16px', fontWeight: 'bold', marginBottom: '20px', cursor: 'pointer' }}
          >
            â† Back
          </button>

          <h2 style={{ fontFamily: "'Press Start 2P', cursive", fontSize: '24px', color: 'white', textAlign: 'center', marginBottom: '30px', textShadow: '3px 3px 0 rgba(0,0,0,0.3)' }}>
            SELECT LEVEL
          </h2>

          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '15px', maxWidth: '800px', margin: '0 auto' }}>
            {levels.map(lvl => {
              const unlocked = unlockedLevels.includes(lvl.id);
              return (
                <div
                  key={lvl.id}
                  onClick={() => { if (unlocked) { AudioManager.playClick(); onSelectLevel(lvl.id); } }}
                  style={{
                    background: unlocked ? 'white' : 'rgba(255,255,255,0.3)',
                    borderRadius: '15px',
                    padding: '20px',
                    textAlign: 'center',
                    cursor: unlocked ? 'pointer' : 'not-allowed',
                    boxShadow: '0 4px 15px rgba(0,0,0,0.2)',
                    opacity: unlocked ? 1 : 0.6,
                    position: 'relative',
                    overflow: 'hidden'
                  }}
                >
                  {!unlocked && <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', fontSize: '40px' }}>ğŸ”’</div>}
                  <div style={{ fontSize: '36px', marginBottom: '10px', filter: unlocked ? 'none' : 'blur(3px)' }}>{lvl.id}</div>
                  <div style={{ fontSize: '14px', fontWeight: 'bold', color: '#764ba2', marginBottom: '10px', filter: unlocked ? 'none' : 'blur(3px)' }}>{lvl.name}</div>
                  <div style={{ fontSize: '12px', color: '#999', filter: unlocked ? 'none' : 'blur(3px)' }}>ğŸ’° {lvl.reward} coins</div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Shop Screen
    function ShopScreen({ coins, inventory, selectedSkin, onPurchase, onSelectSkin, onBack }) {
      return (
        <div style={{ width: '100%', height: '100%', background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', overflowY: 'auto', padding: '20px' }}>
          <button
            onClick={() => { AudioManager.playClick(); onBack(); }}
            style={{ background: 'rgba(255,255,255,0.9)', border: 'none', borderRadius: '10px', padding: '10px 20px', fontSize: '16px', fontWeight: 'bold', marginBottom: '20px', cursor: 'pointer' }}
          >
            â† Back
          </button>

          <div style={{ background: 'rgba(255,255,255,0.9)', borderRadius: '15px', padding: '15px', marginBottom: '20px', textAlign: 'center' }}>
            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FFD700' }}>ğŸ’° {coins} Coins</div>
          </div>

          <h2 style={{ fontFamily: "'Press Start 2P', cursive", fontSize: '20px', color: 'white', textAlign: 'center', marginBottom: '30px', textShadow: '3px 3px 0 rgba(0,0,0,0.3)' }}>
            ğŸ›’ SHOP
          </h2>

          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '15px', maxWidth: '800px', margin: '0 auto' }}>
            {SHOP_ITEMS.map(item => {
              const owned = inventory.includes(item.id);
              const canAfford = coins >= item.cost;
              const isSelected = selectedSkin === item.id;
              const clickable = (!owned && canAfford) || (owned && item.type === 'skin');
              return (
                <div
                  key={item.id}
                  onClick={() => {
                    if (!clickable) return;
                    if (!owned && canAfford) onPurchase(item);
                    else if (owned && item.type === 'skin') { AudioManager.playClick(); onSelectSkin(item.id); }
                  }}
                  style={{
                    background: owned ? (isSelected ? '#90EE90' : 'white') : 'rgba(255,255,255,0.7)',
                    borderRadius: '15px',
                    padding: '20px',
                    textAlign: 'center',
                    cursor: clickable ? 'pointer' : 'not-allowed',
                    boxShadow: '0 4px 15px rgba(0,0,0,0.2)',
                    border: isSelected ? '3px solid #32CD32' : 'none'
                  }}
                >
                  <div style={{ fontSize: '40px', marginBottom: '10px' }}>{item.type === 'skin' ? 'âœ‹' : 'âš¡'}</div>
                  <div style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '10px', color: '#333' }}>{item.name}</div>
                  {owned ? (
                    <div style={{ fontSize: '12px', color: '#32CD32', fontWeight: 'bold' }}>{isSelected ? 'EQUIPPED' : 'OWNED'}</div>
                  ) : (
                    <div style={{ fontSize: '14px', color: canAfford ? '#FFD700' : '#999', fontWeight: 'bold' }}>ğŸ’° {item.cost}</div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Achievements Screen
    function AchievementsScreen({ achievements, allAchievements, onBack }) {
      return (
        <div style={{ width: '100%', height: '100%', background: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', overflowY: 'auto', padding: '20px' }}>
          <button
            onClick={() => { AudioManager.playClick(); onBack(); }}
            style={{ background: 'rgba(255,255,255,0.9)', border: 'none', borderRadius: '10px', padding: '10px 20px', fontSize: '16px', fontWeight: 'bold', marginBottom: '20px', cursor: 'pointer' }}
          >
            â† Back
          </button>

          <h2 style={{ fontFamily: "'Press Start 2P', cursive", fontSize: '20px', color: '#333', textAlign: 'center', marginBottom: '10px', textShadow: '2px 2px 0 rgba(255,255,255,0.5)' }}>
            ğŸ† ACHIEVEMENTS
          </h2>

          <div style={{ textAlign: 'center', marginBottom: '30px', fontSize: '18px', fontWeight: 'bold', color: '#666' }}>
            {achievements.length} / {allAchievements.length} Unlocked
          </div>

          <div style={{ display: 'flex', flexDirection: 'column', gap: '15px', maxWidth: '600px', margin: '0 auto' }}>
            {allAchievements.map(a => {
              const unlocked = achievements.includes(a.id);
              return (
                <div
                  key={a.id}
                  style={{
                    background: unlocked ? 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' : 'rgba(255,255,255,0.5)',
                    borderRadius: '15px',
                    padding: '20px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '15px',
                    boxShadow: '0 4px 15px rgba(0,0,0,0.1)',
                    opacity: unlocked ? 1 : 0.6
                  }}
                >
                  <div style={{ fontSize: '50px', filter: unlocked ? 'none' : 'grayscale(100%)' }}>ğŸ†</div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#333', marginBottom: '5px' }}>{a.name}</div>
                    <div style={{ fontSize: '14px', color: '#666', marginBottom: '5px' }}>{a.desc}</div>
                    <div style={{ fontSize: '12px', color: '#FFD700', fontWeight: 'bold' }}>ğŸ’° +{a.reward} coins</div>
                  </div>
                  {unlocked && <div style={{ fontSize: '30px' }}>âœ“</div>}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Game Screen Component
    function GameScreen({ level, skin, onWin, onLose, onQuit }) {
      const [fingerX, setFingerX] = useState(10);
      const [teacherWatching, setTeacherWatching] = useState(false);
      const [caughtCount, setCaughtCount] = useState(0);
      const [gameTime, setGameTime] = useState(0);
      const [isMoving, setIsMoving] = useState(false);
      const [gameOver, setGameOver] = useState(false);
      const [won, setWon] = useState(false);
      const [particles, setParticles] = useState([]);
      const [justCaught, setJustCaught] = useState(false);
      const [isTurning, setIsTurning] = useState(false);

      const targetX = 75;
      const maxCatches = level.catches;
      const timerRef = useRef(null);
      const teacherTimerRef = useRef(null);
      const gameOverRef = useRef(false);
      const movingRef = useRef(false);

      useEffect(() => {
        movingRef.current = isMoving;
      }, [isMoving]);

      useEffect(() => {
        timerRef.current = setInterval(() => setGameTime(t => t + 0.1), 100);
        scheduleTeacherLook();
        return () => { 
          clearInterval(timerRef.current); 
          clearTimeout(teacherTimerRef.current); 
        };
      }, []);

      const scheduleTeacherLook = () => {
        const baseDelay = 2000 / level.difficulty;
        const lookDelay = Math.random() * baseDelay + 1000;

        teacherTimerRef.current = setTimeout(() => {
          if (gameOverRef.current) return;
          
          // Teacher starts turning around
          setIsTurning(true);
          
          // After turn animation, check if caught
          setTimeout(() => {
            setTeacherWatching(true);
            setIsTurning(false);
            
            // Check if player was moving when teacher turned
            if (movingRef.current) {
              console.log('CAUGHT! Player was moving');
              setCaughtCount(prev => {
                const newCount = prev + 1;
                console.log('New caught count:', newCount, 'Max:', maxCatches);
                
                setJustCaught(true);
                setTimeout(() => setJustCaught(false), 500);
                AudioManager.playFail();
                
                if (newCount >= maxCatches) {
                  console.log('Game Over - too many catches');
                  setTimeout(() => endGame(false), 800);
                }
                return newCount;
              });
            }
          }, 300);

          const watchDuration = Math.random() * 1500 + 800;
          setTimeout(() => {
            if (!gameOverRef.current) {
              setTeacherWatching(false);
              scheduleTeacherLook();
            }
          }, watchDuration + 300);
        }, lookDelay);
      };

      const endGame = (victory) => {
        if (gameOverRef.current) return;
        console.log('End game called, victory:', victory);
        gameOverRef.current = true;
        setGameOver(true);
        setWon(victory);
        clearInterval(timerRef.current);
        clearTimeout(teacherTimerRef.current);

        setTimeout(() => {
          if (victory) onWin(Math.round(gameTime * 10) / 10, caughtCount);
          else onLose();
        }, 2000);
      };

      useEffect(() => {
        if (isMoving && !teacherWatching && !isTurning && !gameOver) {
          const speed = 0.8;
          setFingerX(x => {
            const next = x + speed;
            if (next >= targetX) { 
              endGame(true); 
              return targetX; 
            }
            return next;
          });
        }
      }, [isMoving, teacherWatching, isTurning, gameOver]);

      useEffect(() => {
        if (won) {
          const newParticles = Array.from({ length: 20 }).map((_, i) => ({
            id: Math.random(),
            x: 50 + Math.random() * 50,
            y: 50,
            delay: i * 0.1
          }));
          setParticles(newParticles);
        }
      }, [won]);

      const getSkinColor = () => {
        switch (skin) {
          case 'rainbow_finger':
            return 'linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3)';
          case 'golden_finger':
            return 'linear-gradient(135deg, #FFD700, #FFA500)';
          case 'ninja_finger':
            return 'linear-gradient(135deg, #2c3e50, #34495e)';
          default:
            return '#ffdbac';
        }
      };

      return (
        <div
          style={{ width: '100%', height: '100%', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', position: 'relative', touchAction: 'none', userSelect: 'none' }}
          onMouseDown={() => !gameOver && setIsMoving(true)}
          onMouseUp={() => setIsMoving(false)}
          onTouchStart={() => !gameOver && setIsMoving(true)}
          onTouchEnd={() => setIsMoving(false)}
        >
          <div style={{ position: 'absolute', top: 0, left: 0, right: 0, background: 'rgba(0,0,0,0.3)', padding: '15px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', color: 'white', fontWeight: 'bold', zIndex: 10 }}>
            <button
              onClick={() => { AudioManager.playClick(); onQuit(); }}
              style={{ background: 'rgba(255,255,255,0.3)', border: 'none', borderRadius: '8px', padding: '8px 15px', color: 'white', fontWeight: 'bold', cursor: 'pointer' }}
            >
              âŒ Quit
            </button>
            <div style={{ fontSize: '16px' }}>Level {level.id}: {level.name}</div>
            <div style={{ width: 60 }} />
          </div>

          <div style={{ position: 'absolute', top: '60px', left: '50%', transform: 'translateX(-50%)', display: 'flex', gap: '20px', zIndex: 10 }}>
            <div style={{ background: 'rgba(255,255,255,0.9)', borderRadius: '10px', padding: '10px 20px', fontWeight: 'bold' }}>â±ï¸ {gameTime.toFixed(1)}s</div>
            <div style={{ 
              background: caughtCount >= maxCatches - 1 ? 'rgba(255,0,0,0.9)' : 'rgba(255,255,255,0.9)', 
              borderRadius: '10px', 
              padding: '10px 20px', 
              fontWeight: 'bold',
              animation: justCaught ? 'shake 0.5s' : 'none'
            }}>
              âŒ {caughtCount}/{maxCatches}
            </div>
          </div>

          {(teacherWatching || isTurning) && !gameOver && (
            <div style={{ 
              position: 'absolute', 
              top: '30%', 
              left: '50%', 
              transform: 'translateX(-50%)', 
              background: 'rgba(255,0,0,0.9)', 
              color: 'white', 
              padding: '20px 40px', 
              borderRadius: '15px', 
              fontSize: '24px', 
              fontWeight: 'bold', 
              animation: teacherWatching ? 'pulse 0.5s ease-in-out infinite' : 'none', 
              zIndex: 20, 
              textAlign: 'center' 
            }}>
              {isTurning ? 'âš ï¸ TURNING AROUND!' : 'ğŸ‘€ TEACHER LOOKING!'}
              <br/>STOP!
            </div>
          )}

          {gameOver && (
            <div style={{ 
              position: 'absolute', 
              top: '50%', 
              left: '50%', 
              transform: 'translate(-50%, -50%)', 
              background: won ? 'rgba(0,255,0,0.95)' : 'rgba(255,0,0,0.95)', 
              color: 'white', 
              padding: '40px', 
              borderRadius: '20px', 
              fontSize: '32px', 
              fontWeight: 'bold', 
              animation: won ? 'slideIn 0.5s ease-out' : 'caughtShake 0.5s ease-out', 
              zIndex: 30, 
              textAlign: 'center', 
              boxShadow: '0 10px 40px rgba(0,0,0,0.5)' 
            }}>
              {won ? (
                <>
                  ğŸ‰ YOU WIN! ğŸ‰<br/>
                  <div style={{ fontSize: '18px', marginTop: '15px' }}>
                    Time: {gameTime.toFixed(1)}s<br/>
                    Reward: ğŸ’° {level.reward} coins
                    {caughtCount === 0 && <><br/>Perfect! +50 bonus!</>}
                  </div>
                </>
              ) : (
                <>
                  ğŸ˜± BUSTED! ğŸ˜±<br/>
                  <div style={{ fontSize: '18px', marginTop: '15px' }}>
                    Caught {caughtCount} times!<br/>
                    Try again!
                  </div>
                </>
              )}
            </div>
          )}

          {particles.map(p => (
            <div key={p.id} style={{ position: 'absolute', left: `${p.x}%`, top: `${p.y}%`, fontSize: '30px', animation: `coinCollect 1s ease-out ${p.delay}s forwards`, zIndex: 25 }}>ğŸ’°</div>
          ))}

          <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: '90%', maxWidth: '700px', height: '350px' }}>
            <div style={{ position: 'absolute', bottom: '-50px', left: 0, right: 0, height: '25px', background: 'rgba(255,255,255,0.3)', borderRadius: '12px', overflow: 'hidden', border: '2px solid rgba(255,255,255,0.5)' }}>
              <div style={{ 
                height: '100%', 
                width: `${((fingerX - 10) / (targetX - 10)) * 100}%`, 
                background: caughtCount >= maxCatches - 1 ? 'linear-gradient(90deg, #ff0000, #ff6b6b)' : 'linear-gradient(90deg, #00ff00, #ffff00)', 
                transition: 'width 0.1s',
                boxShadow: 'inset 0 2px 4px rgba(0,0,0,0.2)'
              }} />
            </div>

            {/* Student face with nose */}
            <div style={{ position: 'absolute', left: '15%', top: '50%', transform: 'translateY(-50%)' }}>
              <div style={{ width: '140px', height: '140px', borderRadius: '50%', background: '#ffd8a8', border: '4px solid #333', position: 'relative', boxShadow: '0 4px 15px rgba(0,0,0,0.3)' }}>
                {/* Eyes */}
                <div style={{ position: 'absolute', width: '15px', height: '20px', borderRadius: '50%', background: 'white', border: '2px solid black', left: '30px', top: '45px' }}>
                  <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: 'black', position: 'absolute', left: '1px', top: '5px' }} />
                </div>
                <div style={{ position: 'absolute', width: '15px', height: '20px', borderRadius: '50%', background: 'white', border: '2px solid black', right: '30px', top: '45px' }}>
                  <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: 'black', position: 'absolute', right: '1px', top: '5px' }} />
                </div>

                {/* Nose - prominent and 3D */}
                <div style={{ 
                  position: 'absolute', 
                  width: '42px', 
                  height: '50px', 
                  background: 'linear-gradient(135deg, #ffb380 0%, #ffa060 100%)', 
                  border: '3px solid #333', 
                  left: '50%', 
                  top: '58%', 
                  transform: 'translate(-50%, -50%)',
                  borderRadius: '20px 20px 25px 25px',
                  boxShadow: 'inset -2px -2px 5px rgba(0,0,0,0.2), 2px 2px 8px rgba(0,0,0,0.3)'
                }}>
                  {/* Nostrils - larger and more defined */}
                  <div style={{ position: 'absolute', width: '10px', height: '12px', borderRadius: '50%', background: '#333', left: '8px', bottom: '8px', boxShadow: 'inset 0 2px 3px rgba(0,0,0,0.5)' }} />
                  <div style={{ position: 'absolute', width: '10px', height: '12px', borderRadius: '50%', background: '#333', right: '8px', bottom: '8px', boxShadow: 'inset 0 2px 3px rgba(0,0,0,0.5)' }} />
                  
                  {/* Nose bridge highlight */}
                  <div style={{ position: 'absolute', width: '15px', height: '25px', background: 'rgba(255,255,255,0.4)', borderRadius: '50%', left: '5px', top: '5px', filter: 'blur(3px)' }} />
                </div>

                {/* Mouth */}
                <div style={{ position: 'absolute', width: '35px', height: '8px', borderRadius: '0 0 20px 20px', background: '#333', left: '50%', bottom: '25px', transform: 'translateX(-50%)' }} />
              </div>
            </div>

            {/* Teacher in background */}
            <div style={{ 
              position: 'absolute', 
              right: '5%', 
              top: '50%', 
              transform: teacherWatching ? 'translateY(-50%) rotateY(0deg)' : 'translateY(-50%) rotateY(180deg)',
              transition: 'transform 0.3s ease-out',
              transformStyle: 'preserve-3d',
              perspective: '1000px'
            }}>
              <div style={{ 
                width: '100px', 
                height: '100px', 
                borderRadius: '50%', 
                background: '#e8d4b8', 
                border: '3px solid #333', 
                position: 'relative',
                boxShadow: '0 4px 10px rgba(0,0,0,0.3)'
              }}>
                {/* Teacher glasses */}
                <div style={{ position: 'absolute', top: '35px', left: '50%', transform: 'translateX(-50%)', display: 'flex', gap: '10px' }}>
                  <div style={{ width: '18px', height: '18px', borderRadius: '50%', border: '3px solid #333', background: 'rgba(255,255,255,0.3)' }} />
                  <div style={{ width: '18px', height: '18px', borderRadius: '50%', border: '3px solid #333', background: 'rgba(255,255,255,0.3)' }} />
                </div>

                {/* Angry eyes when watching */}
                {teacherWatching && (
                  <>
                    <div style={{ position: 'absolute', width: '12px', height: '12px', borderRadius: '50%', background: 'black', left: '25px', top: '40px' }} />
                    <div style={{ position: 'absolute', width: '12px', height: '12px', borderRadius: '50%', background: 'black', right: '25px', top: '40px' }} />
                    {/* Angry eyebrows */}
                    <div style={{ position: 'absolute', width: '20px', height: '3px', background: 'black', left: '18px', top: '32px', transform: 'rotate(-15deg)' }} />
                    <div style={{ position: 'absolute', width: '20px', height: '3px', background: 'black', right: '18px', top: '32px', transform: 'rotate(15deg)' }} />
                  </>
                )}

                {/* Mustache */}
                <div style={{ position: 'absolute', width: '40px', height: '12px', background: '#333', borderRadius: '0 0 20px 20px', left: '50%', top: '60px', transform: 'translateX(-50%)' }} />
                
                {/* Mouth */}
                <div style={{ position: 'absolute', width: '30px', height: '6px', background: teacherWatching ? '#ff0000' : '#333', borderRadius: teacherWatching ? '20px 20px 0 0' : '0 0 15px 15px', left: '50%', bottom: '20px', transform: 'translateX(-50%)' }} />
              </div>
              
              {/* Teacher body */}
              <div style={{ width: '80px', height: '60px', background: '#2c3e50', position: 'absolute', top: '100px', left: '50%', transform: 'translateX(-50%)', borderRadius: '0 0 15px 15px', border: '3px solid #333', borderTop: 'none' }} />
            </div>

            {/* Finger - animated to go toward nostril */}
            <div style={{ 
              position: 'absolute', 
              left: `${fingerX}%`, 
              top: '50%', 
              transform: 'translateY(-50%)', 
              transition: 'left 0.1s linear',
              zIndex: 5
            }}>
              {/* Hand/Palm */}
              <div style={{ 
                width: '45px', 
                height: '55px', 
                background: getSkinColor(), 
                borderRadius: '40% 60% 60% 40% / 60% 60% 40% 40%',
                border: '3px solid #333', 
                position: 'relative',
                boxShadow: '2px 2px 8px rgba(0,0,0,0.3)'
              }}>
                {/* Index Finger - pointing */}
                <div style={{ 
                  position: 'absolute', 
                  right: '-25px', 
                  top: '5px',
                  width: '40px',
                  height: '22px',
                  background: getSkinColor(),
                  borderRadius: '0 50% 50% 0',
                  border: '3px solid #333',
                  borderLeft: 'none',
                  boxShadow: '2px 2px 5px rgba(0,0,0,0.2)'
                }}>
                  {/* Fingertip */}
                  <div style={{ 
                    position: 'absolute',
                    right: '-3px',
                    top: '-3px',
                    width: '18px',
                    height: '28px',
                    background: getSkinColor(),
                    borderRadius: '50%',
                    border: '3px solid #333',
                    boxShadow: 'inset -2px -2px 4px rgba(0,0,0,0.2)'
                  }} />
                  
                  {/* Fingernail */}
                  <div style={{ 
                    position: 'absolute', 
                    right: '2px', 
                    top: '2px', 
                    width: '12px', 
                    height: '10px', 
                    background: 'rgba(255,255,255,0.9)', 
                    borderRadius: '50%', 
                    border: '2px solid #333',
                    boxShadow: 'inset 0 1px 2px rgba(0,0,0,0.1)'
                  }} />
                </div>

                {/* Thumb */}
                <div style={{ 
                  position: 'absolute', 
                  left: '5px', 
                  bottom: '-10px',
                  width: '20px',
                  height: '28px',
                  background: getSkinColor(),
                  borderRadius: '50% 20% 40% 50%',
                  border: '3px solid #333',
                  transform: 'rotate(-20deg)'
                }} />

                {/* Other fingers (curled) */}
                <div style={{ position: 'absolute', bottom: '5px', right: '8px', display: 'flex', gap: '2px' }}>
                  {[0, 1, 2].map(i => (
                    <div key={i} style={{ 
                      width: '8px', 
                      height: '15px', 
                      background: getSkinColor(), 
                      borderRadius: '50% 50% 0 0',
                      border: '2px solid #333',
                      borderBottom: 'none'
                    }} />
                  ))}
                </div>
              </div>
            </div>
          </div>

          {!gameOver && (
            <div style={{ position: 'absolute', bottom: '100px', left: '50%', transform: 'translateX(-50%)', color: 'white', fontSize: '18px', fontWeight: 'bold', textAlign: 'center', textShadow: '2px 2px 4px rgba(0,0,0,0.5)' }}>
              {isMoving ? 'ğŸƒ Moving...' : 'ğŸ‘† Tap & Hold to Move'}
            </div>
          )}
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Game />);
  </script>

</body>
</html>